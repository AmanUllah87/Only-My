
CREATE VIEW [dbo].[V_Indoor_Bill]
AS
SELECT a.Id As BillId, a.BillNo,a.BillDate,a.BillTime,a.AdmId,b.AdmNo,b.PtName,b.PtAge,b.PtSex,b.PtAddress,c.DeptName,c.DeptId,a.TotalAmt,a.TotalDiscount,a.AdvanceAmt,a.PaidAmt,a.Remarks,a.PostedBy,d.Charge,d.Unit,d.TotCharge,d.TestId,d.LessAmt,d.TestName, CASE WHEN d.DrId!=0 THEN '(B).Doctor' ELSE '(A).Hospital' END AS GroupName
FROM tb_IN_BILL_MASTER a INNER JOIN tb_in_ADMISSION b ON a.AdmId=b.Id
INNER JOIN V_IN_BED_WITH_DEPT c ON a.BedId=c.Id
INNER JOIN tb_in_BILL_DETAIL d ON a.Id=d.MasterId

CREATE VIEW [dbo].[V_in_TestAdd_Bill]
AS
SELECT a.TrNo AS BillNo,a.TrDate AS  BillDate,b.PtName As PatientName,b.ContactNo AS  MobileNo,b.PtAddress,a.TestId,a.TestName,
a.Charge,a.Unit,a.TotCharge,a.Remarks,a.PostedBy,c.Name AS Bed,c.DeptName,d.Name AS UnderDrName
FROM tb_in_TEST_ADD_LIST a INNER JOIN tb_in_ADMISSION b ON a.AdmId=b.Id 
INNER JOIN V_IN_BED_WITH_DEPT c ON a.BedId=c.Id
INNER JOIN tb_DOCTOR d ON b.UnderDrId=d.Id

CREATE VIEW [dbo].[V_in_DueList]
AS
SELECT b.AdmNo,b.PtName,b.PtSex,b.PtAge,b.ContactNo, a.AdmId,a.BedId,c.Name AS Bed,c.DeptName,c.DeptId, b.RefId ,d.Name AS RefDrName,b.UnderDrId,e.Name AS UnderDrName,SUM(a.TotCharge-a.LessAmt-a.CollAmt-a.ExtraLessAmt-(-a.RtnAmt)) AS DueAmt,f.BillDate AS ReleaseDate
FROM tb_in_PATIENT_LEDGER a INNER JOIN tb_in_ADMISSION b ON a.AdmId=b.Id
INNER JOIN V_IN_BED_WITH_DEPT c ON a.BedId=c.Id
INNER JOIN tb_DOCTOR d ON b.RefId=d.Id
INNER JOIN tb_DOCTOR e ON b.UnderDrId=e.Id
INNER JOIN tb_IN_BILL_MASTER f ON b.id=f.AdmId
GROUP BY a.AdmId,a.BedId,c.Name,c.DeptName,c.DeptId, b.RefId ,d.Name,b.UnderDrId,e.Name,b.AdmNo,b.PtName,b.PtSex,b.PtAge,b.ContactNo,f.BillDate
HAVING SUM(a.TotCharge-a.LessAmt-a.CollAmt-a.ExtraLessAmt-(-a.RtnAmt))>0

CREATE VIEW [dbo].[V_In_Diag_Due_Coll_List]
AS
SELECT a.TrNo,a.TrDate,b.PtName AS  PatientName,b.ContactNo AS  MobileNo,a.TotalAmt,a.LessAmt,a.PostedBy,b.UnderDrId AS ConsDrId,c.Name AS ConsDrName,b.DeptName,b.BedName,a.AdmId
FROM tb_DUE_COLL a 
INNER JOIN V_Admission_List b ON a.AdmId=b.id
INNER JOIN tb_Doctor c ON b.UnderDrId=c.Id 
WHERE a.AdmId<>0

CREATE VIEW [dbo].[V_in_Daily_Collection_List]
AS
SELECT BillNo AS  TrNo,BillDate AS  TrDate,a.Id AS MasterId,a.BillNo,a.BillDate,b.PtName AS  PatientName,a.PostedBy,a.TotalAmt AS  SalesAmt,
a.TotalDiscount AS  LessAmt,a.PaidAmt AS  CollAmt,'ReleaseTimeCollection'AS Status 
FROM tb_IN_BILL_MASTER a INNER JOIN tb_in_ADMISSION b ON a.AdmId=b.Id

CREATE VIEW [dbo].[V_in_Counted_List_Of_Tested_Item]
AS
SELECT c.Name AS TestName,a.TestId, COUNT(TestId) AS NoOfTest, SUM(a.Charge) AS Charge,c.SubProjectId,'Procedure' AS GroupName,b.BillDate
FROM tb_in_BILL_DETAIL a INNER JOIN tb_IN_BILL_MASTER B on a.MasterId=b.id
INNER JOIN tb_TestChart  c ON a.TestId=c.Id
GROUP BY c.Name,a.TestId,c.SubProjectId,b.BillDate

CREATE VIEW [dbo].[V_IN_BED_WITH_DEPT] AS
SELECT a.Id,a.Name,a.Floor,a.BedType,a.Charge,a.SrvCharge,a.PostedBy,a.DeptId ,b.Name AS DeptName,a.BookStatus
FROM tb_IN_BED a INNER JOIN tb_IN_DEPARTMENT b ON a.DeptId=b.Id

CREATE VIEW [dbo].[V_Advance_Collection_List]
AS
SELECT a.TrNo,a.TrDate,a.Amount,a.PostedBy AS UserName ,b.Id,b.DeptId,b.RegId,b.AdmNo,b.AdmDate,b.AdmTime,b.PtName,b.ContactNo,b.PtAge,b.PtSex,b.PtAddress,b.ChiefComplain,b.RefId,b.RefDrName,b.UnderDrId,b.UnderDrName,b.BedName,b.Floor
FROM tb_in_ADVANCE_COLLECTION a INNER JOIN V_Admission_List b ON a.AdmId=b.Id

CREATE VIEW [dbo].[V_Admission_List]
AS
SELECT a.*,b.Name AS RefDrName,c.Name AS UnderDrName ,d.Name AS BedName,d.Floor,d.DeptName
FROM tb_in_ADMISSION a 
INNER JOIN tb_DOCTOR b ON a.RefId=b.Id
INNER JOIN tb_DOCTOR c ON a.UnderDrId=c.Id
INNER JOIN V_IN_BED_WITH_DEPT d ON a.BedId=d.Id

CREATE TABLE [dbo].[tb_in_TEST_ADD_LIST](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[TrNo] [nvarchar](50) NOT NULL,
	[TrDate] [date] NOT NULL,
	[AdmId] [int] NOT NULL,
	[BedId] [int] NOT NULL,
	[TestId] [int] NOT NULL,
	[TestName] [nvarchar](500) NOT NULL,
	[Charge] [float] NOT NULL,
	[Unit] [float] NOT NULL,
	[TotCharge] [float] NOT NULL,
	[Remarks] [nvarchar](500) NOT NULL,
	[PostedBy] [nvarchar](50) NOT NULL,
	[IpAddress] [nvarchar](50) NOT NULL,
	[EntryDate] [datetime] NOT NULL CONSTRAINT [DF_tb_in_TEST_ADD_LIST_EntryDate]  DEFAULT (getdate())
) ON [PRIMARY]


------------------------------------------------------------Not Done--------------------------------------------
ALTER VIEW [dbo].[V_Due_Invoice_List]
AS
SELECT a.MasterId,b.BillNo,b.BillDate,b.PatientName,b.Age,b.Sex,b.MobileNo,c.Name As ConsDrName,c.Id AS ConsDrId,
Isnull(SUM(a.SalesAmt-a.LessAmt-a.RtnAmt-a.CollAmt),0) AS Balance,b.TotalAmt AS BillAmt,b.RefDrId,d.Name AS RefDrName,b.AdmId
FROM tb_BILL_LEDGER a INNER JOIN tb_BILL_MASTER b ON a.MasterId=b.Id
INNER JOIN tb_Doctor c ON b.UnderDrId=c.Id
INNER JOIN tb_Doctor d ON b.RefDrId=d.Id 
GROUP BY a.MasterId,b.PatientName,b.Age,b.Sex,b.MobileNo,b.BillDate,b.BillNo,c.Name,c.Id,b.TotalAmt,b.RefDrId,d.Name,b.AdmId
HAVING SUM(a.SalesAmt-a.LessAmt-a.RtnAmt-a.CollAmt)>0


ALTER VIEW [dbo].[V_in_DueList]
AS
SELECT b.AdmNo,b.PtName,b.PtSex,b.PtAge,b.ContactNo, a.AdmId,a.BedId,c.Name AS Bed,c.DeptName,c.DeptId, b.RefId ,d.Name AS RefDrName,b.UnderDrId,e.Name AS UnderDrName,SUM(a.TotCharge-a.LessAmt-a.CollAmt-a.ExtraLessAmt-(-a.RtnAmt)) AS DueAmt,f.BillDate AS ReleaseDate,f.BillNo
FROM tb_in_PATIENT_LEDGER a INNER JOIN tb_in_ADMISSION b ON a.AdmId=b.Id
INNER JOIN V_IN_BED_WITH_DEPT c ON a.BedId=c.Id
INNER JOIN tb_DOCTOR d ON b.RefId=d.Id
INNER JOIN tb_DOCTOR e ON b.UnderDrId=e.Id
INNER JOIN tb_IN_BILL_MASTER f ON b.id=f.AdmId
GROUP BY a.AdmId,a.BedId,c.Name,c.DeptName,c.DeptId, b.RefId ,d.Name,b.UnderDrId,e.Name,b.AdmNo,b.PtName,b.PtSex,b.PtAge,b.ContactNo,f.BillDate,f.BillNo
HAVING SUM(a.TotCharge-a.LessAmt-a.CollAmt-a.ExtraLessAmt-(-a.RtnAmt))>0



CREATE VIEW [dbo].[V_in_Due_Collection_List]
AS
SELECT a.TrNo,a.TrDate,a.AdmId ,b.PtName AS  PatientName,b.ContactNo AS MobileNo,a.TotalAmt,a.LessAmt,a.PostedBy,b.UnderDrId AS ConsDrId,c.Name AS ConsDrName,a.Remarks
FROM tb_DUE_COLL a INNER JOIN tb_in_ADMISSION b ON a.AdmId=b.id
INNER JOIN tb_Doctor c ON b.UnderDrId=c.Id

------------------------------------------------------------------------------------------------------------------------------
